from src.core.config_logs import get_logger
from src.core.config import get_icon_path
logger = get_logger(__name__)
from tkinter import (
    Label, Frame, Button, Entry, Toplevel, Canvas, Scrollbar,
    NW, LEFT, RIGHT, TOP, BOTTOM, W, E, N, S,
    BOTH, X, Y, VERTICAL, HORIZONTAL, END,
    TRUE, FALSE, GROOVE, RAISED, FLAT, StringVar
)
from tkinter import ttk, messagebox
from PIL import ImageTk, Image
from src.core.conexao import conectar_bd
from typing import Any, cast

class InterfaceAdministrativa:
    def __init__(self, master, janela_principal=None):
        # Armazenar a refer├¬ncia da janela principal
        self.janela_principal = janela_principal
        
        # Se a janela principal foi fornecida, escond├¬-la
        if self.janela_principal:
            self.janela_principal.withdraw()
        
        # Cores - usando esquema de cores similar ao da main.py
        self.co0 = "#2e2d2b"  # Preta
        self.co1 = "#feffff"  # Branca
        self.co2 = "#e5e5e5"  # Cinza claro
        self.co3 = "#00a095"  # Verde
        self.co4 = "#403d3d"  # Letra cinza escuro
        self.co5 = "#003452"  # Azul escuro
        self.co6 = "#ef5350"  # Vermelho
        self.co7 = "#038cfc"  # Azul principal
        self.co8 = "#263238"  # Verde escuro
        self.co9 = "#e9edf5"  # Azul claro
        
        # Novas cores para melhorar a est├®tica
        self.co10 = "#f5f5f5"  # Fundo alternativo
        self.co11 = "#d0d0d0"  # Borda
        self.co12 = "#6c757d"  # Texto secund├írio

        self.master = master
        self.master.title("Administra├º├úo - Escolas e Disciplinas")
        self.master.geometry('950x670')
        self.master.configure(background=self.co10)  # Alterado para cor de fundo mais suave
        self.master.resizable(width=TRUE, height=TRUE)
        
        # Adicionar um bot├úo de maximizar no t├¡tulo da janela (Windows)
        try:
            self.master.attributes('-toolwindow', False)
            self.master.attributes('-fullscreen', False)
        except:
            pass
        
        # Vincular evento de redimensionamento da janela
        self.master.bind("<Configure>", self.on_window_resize)
        
        # Capturar evento de fechamento da janela
        self.master.protocol("WM_DELETE_WINDOW", self.fechar_janela)

        # Configurar a janela para expandir
        self.master.grid_rowconfigure(0, weight=0)  # Logo
        self.master.grid_rowconfigure(1, weight=0)  # Separador
        self.master.grid_rowconfigure(2, weight=0)  # Dados
        self.master.grid_rowconfigure(3, weight=0)  # Separador
        self.master.grid_rowconfigure(4, weight=3)  # Tabela Escolas (peso maior)
        self.master.grid_rowconfigure(5, weight=2)  # Tabela Disciplinas
        self.master.grid_columnconfigure(0, weight=1)  # Coluna principal expande

        # Conectar ao banco de dados usando a mesma fun├º├úo que main.py
        self.conn = conectar_bd()
        if self.conn is None:
            messagebox.showerror("Erro de Conex├úo", "N├úo foi poss├¡vel conectar ao banco de dados")
            self.fechar_janela()
            return

        try:
            self.cursor = self.conn.cursor()
        except Exception as e:
            messagebox.showerror("Erro de Conex├úo", f"N├úo foi poss├¡vel criar cursor: {str(e)}")
            self.fechar_janela()
            return

        # Criar frames
        self.criar_frames()
        self.criar_header()
        self.criar_botoes()
        self.criar_tabelas()
        self.carregar_escolas()

    def fechar_janela(self):
        # Fechar a conex├úo com o banco de dados
        if hasattr(self, 'conn') and self.conn:
            try:
                self.cursor.close()
                self.conn.close()
            except:
                pass
        
        # Destruir a janela atual
        self.master.destroy()
        
        # Se a janela principal existir, mostr├í-la novamente
        if self.janela_principal:
            self.janela_principal.deiconify()
            
    def criar_frames(self):
        # Frame Logo
        self.frame_logo = Frame(self.master, height=52, bg=self.co7)
        self.frame_logo.grid(row=0, column=0, sticky='nsew')
        self.frame_logo.grid_propagate(False)  # Manter altura fixa
        self.frame_logo.grid_columnconfigure(0, weight=1)  # Permitir expans├úo horizontal

        # Separador
        ttk.Separator(self.master, orient=HORIZONTAL).grid(row=1, column=0, sticky='ew')

        # Frame Dados (Bot├Áes)
        self.frame_dados = Frame(self.master, height=65, bg=self.co10)
        self.frame_dados.grid(row=2, column=0, sticky='nsew', padx=5)

        # Separador
        ttk.Separator(self.master, orient=HORIZONTAL).grid(row=3, column=0, sticky='ew')

        # Frame Escolas - com borda e cor de fundo mais suave
        self.frame_escolas = Frame(self.master, bg=self.co10, 
                                   highlightbackground=self.co11, 
                                   highlightthickness=1)
        self.frame_escolas.grid(row=4, column=0, sticky='nsew', padx=10, pady=5)
        
        # Divisor entre Escolas e Disciplinas
        divisor_frame = Frame(self.master, height=2, bg=self.co11)
        divisor_frame.grid(row=4, column=0, sticky='sew', padx=10)

        # Frame Disciplinas - com borda e cor de fundo mais suave
        self.frame_disciplinas = Frame(self.master, bg=self.co10, 
                                       highlightbackground=self.co11, 
                                       highlightthickness=1)
        self.frame_disciplinas.grid(row=5, column=0, sticky='nsew', padx=10, pady=5)

    def criar_header(self):
        # T├¡tulo no frame_logo
        try:
            app_img = Image.open(get_icon_path('learning.png'))
            app_img = app_img.resize((45, 45))
            self.app_logo = ImageTk.PhotoImage(app_img)
            app_logo_label = Label(
                self.frame_logo, 
                image=self.app_logo,
                text=" Gest├úo de Escolas e Disciplinas",
                compound=LEFT,
                relief=RAISED,
